const IssuesAPI={requestIssuesAPI(a,o,r){let l=10;!function n(){return new Promise((e,s)=>{let t=0,i=setTimeout(()=>{0===t&&(t=2,i=null,s("请求超时"),0==l&&r())},5e3);fetch(a).then(function(s){if(2!==t&&(clearTimeout(i),e(s),i=null,t=1),s.ok)return s.json();throw new Error("Network response was not ok.")}).then(function(s){l=0,o(s)}).catch(function(s){l>0?(l-=1,setTimeout(()=>{n()},5e3)):r()})})}()},parseIssueStrToJson(s){let e=s.match(/```json[\s|\S]*```/);if(e&&e.length>0&&(e=e[0]),e&&(e=e.split("```json")[1].split("```")[0],e))return JSON.parse(e)},groupIssuesData(t,e){var n=new Object;if(e.length>0)if(null!=t.group){const o=t.group.split(":");if(o.length>1){const r=o[0];let s=o[1];for(r&&s&&(s=s.split(",")),t.group=s,i=0;i<e.length;i++){const t=this.parseIssueStrToJson(e[i].body);if(t&&r in t){let e=t[r];e=e.replace(", ",",").split(",");for(var a=0;a<e.length;a++)if(s.includes(e[a])){let s=n[e[a]];null==s&&(s=new Array),s.push(t),n[e[a]]=s}}}}}else for(t.group=[""],i=0;i<e.length;i++){const t=this.parseIssueStrToJson(e[i].body);if(t){let s=n[""];null==s&&(s=new Array),s.push(t),n[""]=s}}return n},getIssuesAPIForSites(t){const r=$(t.el)[0];$(r).append('<div class="loading"><i class="fa fa-cog fa-2x fa-spin"></i><p>正在加载</p></div>'),this.requestIssuesAPI(t.api,function(s){$(r).find(".loading").remove();const e=IssuesAPI.groupIssuesData(t,s),o=Object.keys(e);t.group.forEach((t,i)=>{const n=e[t];if(n&&n.length>0)for(t.length>0?$(r).append("<h2>"+t+"</h2>"):""==name&&o.length>1&&$(r).append("<h2>未分组</h2>"),$(r).append('<div class="site-card-group '+i+'"></div>'),j=0;j<n.length;j++){const t=n[j];let s="";s=t.screenshot&&t.screenshot.length>0?'<div class="img"><img src="'+t.screenshot+'" onerror="javascript:this.src=\'https://image.thum.io/get/width/1024/crop/768/'+t.url+"';\"/></div>":'<div class="img"></div>';let e='<div class="info">';t.avatar&&t.avatar.length>0&&(e+='<img src="'+t.avatar+'" onerror="javascript:this.src=\'https://image.thum.io/get/width/1024/crop/768/'+t.url+"';\"/>"),e+='<span class="title">'+t.title+'</span><span class="desc">'+t.description+"</span></div>";const a="<a class='site-card' target='_blank' href='"+t.url+"'>"+s+e+"</a>";$(r).find(".site-card-group."+i).append(a)}})},function(){$(r).find(".loading i").remove(),$(r).find(".loading p").text("加载失败，请稍后重试。")})},getIssuesAPIForTimeline(s){const n=$(s.el)[0];$(n).append('<div class="loading"><i class="fa fa-cog fa-2x fa-spin"></i><p>正在加载</p></div>'),this.requestIssuesAPI(s.api,function(s){if($(n).find(".loading").remove(),s.length>0)for(i=0;i<s.length;i++){const e='&nbsp;&nbsp;<a class="comments" target="_blank" href="'+s[i].html_url+'"><i class="fa fa-comment-dots fa-fw"></i>'+s[i].comments+"</a>",t='<div class="timenode">'+('<div class="meta"><p></p><p>'+s[i].title+e+"</p><p></p></div>")+('<div class="body"><p>'+s[i].body+"</p></div>")+"</div>";$(n).append(t)}},function(){$(n).find(".loading i").remove(),$(n).find(".loading p").text("加载失败，请稍后重试。")})},request(){const s=document.getElementsByClassName("issues-api");for(var e=0;e<s.length;e++){const i=s[e],n=i.getAttribute("api"),a=i.getAttribute("group");var t=new Object;t.class=i.getAttribute("class"),t.el=i,t.api=n,t.group=a,t.class.split(" ").includes("sites")?this.getIssuesAPIForSites(t):t.class.split(" ").includes("timeline")&&this.getIssuesAPIForTimeline(t)}}};IssuesAPI.request(),document.addEventListener("pjax:complete",function(){IssuesAPI.request()});